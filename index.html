<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Spese</title>
  <meta name="theme-color" content="#0A84FF" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <style>
    :root {
      --bg:#0b0b0c;
      --card:#121214;
      --muted:#9aa0a6;
      --primary:#0A84FF;
      --ring: 0 0 0 8px rgba(10,132,255,.15);
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; background:linear-gradient(180deg,#0d0f12 0%, #0b0b0c 100%); color:#f3f4f6;}
    .container{max-width:980px; margin:0 auto; padding:16px 16px 96px;}
    .card{background:linear-gradient(180deg,#15161a 0%, #121318 100%); border:1px solid #1f2229; border-radius:20px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.25);}
    .row{display:flex; align-items:center; gap:12px;}
    .grid{display:grid; gap:12px;}
    .muted{color:var(--muted);}
    .stat{flex:1; padding:16px; border-radius:18px; background:radial-gradient(120% 120% at 0% 0%, #161a22 0%, #101217 100%); border:1px solid #1f2229; box-shadow:inset 0 1px 0 rgba(255,255,255,.04);}
    .stat b{font-size:22px}
    .btn{border:1px solid #2a2e36; background:#171a21; color:#e5e7eb; border-radius:14px; padding:8px 12px; cursor:pointer; transition:.2s transform ease, .2s background ease;}
    .btn:hover{transform:translateY(-1px); background:#1b1f27}
    .btn.primary{background:var(--primary); border-color:var(--primary); color:#fff;}
    .btn.ghost{background:transparent; border-color:transparent;}
    .btn.danger{background:#ff3b30; border-color:#ff3b30; color:#fff}
    .input{width:100%; box-sizing:border-box; border:1px solid #2a2e36; background:#121318; color:#e5e7eb; border-radius:12px; padding:10px 12px; outline:none; transition: box-shadow .2s;}
    .input:focus{box-shadow: var(--ring)}
    .list-row{display:block; width:100%; text-align:left; padding:12px 14px; background:transparent; border:0; border-bottom:1px solid #1f2229; color:#e5e7eb;}
    .list-row:hover{background:#14171d}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:16px; position:sticky; top:12px; z-index:5}
    .topbar h1{font-size:18px; font-weight:800; text-transform:capitalize; letter-spacing:.2px;}
    .chev{width:38px; height:38px; border-radius:12px; background:#141821; border:1px solid #222632; display:grid; place-items:center}
    .chev:active{transform:scale(.98)}
    .tabbar{position:fixed; left:0; right:0; bottom:0; padding:8px 12px calc(8px + env(safe-area-inset-bottom)); backdrop-filter: blur(12px); background:rgba(12,13,16,.7); border-top:1px solid #1f2229;}
    .tabs{max-width:980px; margin:0 auto; display:grid; grid-template-columns:repeat(4,1fr); gap:8px;}
    .tab{display:flex; flex-direction:column; gap:2px; align-items:center; background:transparent; border:0; color:#cbd5e1; padding:6px 8px; border-radius:12px; transition:.2s background;}
    .tab.active{background:#182033; color:#cfe3ff; font-weight:700}
    .pill{display:inline-flex; padding:6px 10px; border-radius:999px; background:#141821; border:1px solid #222632; gap:8px; align-items:center}
    .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.55); display:grid; place-items:center; padding:20px; z-index:40; animation: fade .2s ease;}
    .modal{width:100%; max-width:640px; background:#111316; border:1px solid #232732; border-radius:18px; padding:16px; box-shadow:0 20px 50px rgba(0,0,0,.5); animation: pop .18s ease;}
    @keyframes pop { from { transform: translateY(8px) scale(.98); opacity:0 } to { transform:none; opacity:1 } }
    @keyframes fade { from { opacity:0 } to { opacity:1 } }
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#1f2229; border-radius:10px; overflow:hidden}
    .cal-cell{min-height:92px; background:linear-gradient(180deg,#14161b 0%, #101217 100%); padding:6px; position:relative}
    .cal-cell .d{font-size:10px; opacity:.7; margin-bottom:6px}
    .chip{display:inline-flex; font-size:11px; padding:3px 6px; border-radius:8px; background:#182033; margin-bottom:3px}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const LS_KEYS = {
      recurrings: "spese_recurrings_v1",
      budgets: "spese_budgets_v1",
      theme: "spese_theme_v1",
    };

    const FREQ = {
      MONTHLY: { key: "monthly", label: "Mensile" },
      YEARLY: { key: "yearly", label: "Annuale" },
      EVERY_X_MONTHS: (x) => ({ key: \`every_\${x}_months\`, x, label: \`Ogni \${x} mesi\` }),
      BIENNIAL: { key: "biennial", label: "Biennale" },
    };

    const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const toISODate = (d) => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString();
    const startOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1);
    const endOfMonthDate = (date) => new Date(date.getFullYear(), date.getMonth()+1, 0);
    const startOfWeek = (d) => { const n = new Date(d); const day = (n.getDay()+6)%7; n.setDate(n.getDate()-day); n.setHours(0,0,0,0); return n; };
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

    const itMonthYear = new Intl.DateTimeFormat("it-IT", { month: "long", year: "numeric" });
    const cur = new Intl.NumberFormat("it-IT", { style: "currency", currency: "EUR" });

    function saveLS(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function readLS(key, fallback) { try { const v = JSON.parse(localStorage.getItem(key)); return v ?? fallback; } catch { return fallback; }}

    function clampDay(day, date){ const last = endOfMonthDate(date).getDate(); return Math.max(1, Math.min(day ?? 1, last)); }

    function generateMonthPlan(date, recurrings, budgets){
      const month = date.getMonth()+1, year = date.getFullYear(); const items = [];
      recurrings.forEach(r => {
        if (r.excludedMonths?.includes(month)) return;
        const amount = (r.amountOverrides && r.amountOverrides[month]) ?? r.baseAmount;
        const day = clampDay(r.dayOfMonth, date);
        if (r.frequency === FREQ.MONTHLY.key) {
          items.push({ id: uuid(), dateISO: toISODate(new Date(year, month-1, day)), title:r.name, amount, type:'recurring', recurringId:r.id });
        } else if (r.frequency === FREQ.YEARLY.key) {
          if ((r.monthOfYear||1) === month) items.push({ id: uuid(), dateISO: toISODate(new Date(year, month-1, day)), title:r.name, amount, type:'recurring', recurringId:r.id });
        } else if (r.frequency.startsWith("every_")) {
          const x = parseInt(r.frequency.split("_")[1] || "1", 10);
          if (month % x === 0) items.push({ id: uuid(), dateISO: toISODate(new Date(year, month-1, day)), title:r.name, amount, type:'recurring', recurringId:r.id });
        } else if (r.frequency === FREQ.BIENNIAL.key) {
          if ((r.monthOfYear||1) === month && year % 2 === 0) items.push({ id: uuid(), dateISO: toISODate(new Date(year, month-1, day)), title:r.name, amount, type:'recurring', recurringId:r.id });
        }
      });
      const endDate = endOfMonthDate(date);
      budgets.forEach(b => items.push({ id: uuid(), dateISO: toISODate(endDate), title:\`Budget \${b.category}\`, amount:b.cap, type:'budget' }));
      items.sort((a,b)=> new Date(a.dateISO) - new Date(b.dateISO));
      return items;
    }

    const seedRecurrings = () => ([
      { id: uuid(), name: "Spotify", baseAmount: 7.00, category: "Abbonamenti", frequency: FREQ.MONTHLY.key, dayOfMonth: 3, monthOfYear: null, amountOverrides: {}, excludedMonths: [] },
      { id: uuid(), name: "Iliad", baseAmount: 7.99, category: "Telefonia", frequency: FREQ.MONTHLY.key, dayOfMonth: 22, monthOfYear: null, amountOverrides: {}, excludedMonths: [] },
      { id: uuid(), name: "Compassion", baseAmount: 29.00, category: "Donazioni", frequency: FREQ.MONTHLY.key, dayOfMonth: 7, monthOfYear: null, amountOverrides: { 11:50, 12:50 }, excludedMonths: [] },
      { id: uuid(), name: "Assicurazione Auto", baseAmount: 380.00, category: "Auto", frequency: FREQ.YEARLY.key, dayOfMonth: 23, monthOfYear: 8, amountOverrides: {}, excludedMonths: [] },
      { id: uuid(), name: "Revisione Auto", baseAmount: 100.00, category: "Auto", frequency: FREQ.BIENNIAL.key, dayOfMonth: 4, monthOfYear: 5, amountOverrides: {}, excludedMonths: [] },
    ]);
    const seedBudgets = () => ([
      { id: uuid(), category: "Luce", cap: 70 },
      { id: uuid(), category: "Gas", cap: 60 },
      { id: uuid(), category: "Carburante", cap: 80 },
    ]);

    function useSystemTheme(){
      const prefersDark = true;
      const saved = readLS(LS_KEYS.theme, null);
      const [theme, setTheme] = useState(saved || (prefersDark ? 'dark' : 'light'));
      useEffect(()=>{ localStorage.setItem(LS_KEYS.theme, JSON.stringify(theme)); document.documentElement.dataset.theme = theme; }, [theme]);
      return [theme, setTheme];
    }

    function Chev({ onClick, children }){ return <button className="chev" onClick={onClick}>{children}</button>; }
    function TopBar({ title, onPrev, onNext, children }){
      return (
        <div className="topbar">
          <div className="row">
            <Chev onClick={onPrev}>&lsaquo;</Chev>
            <Chev onClick={onNext}>&rsaquo;</Chev>
          </div>
          <h1>{title}</h1>
          <div className="row">{children}</div>
        </div>
      );
    }
    function Stat({label, value}){ return <div className="stat"><div className="muted" style={{fontSize:13}}>{label}</div><b>{value}</b></div>; }
    function Section({title, children}){ return (<div style={{marginTop:24}}><div className="muted" style={{fontSize:13, marginBottom:8}}>{title}</div><div className="card">{children}</div></div>); }
    function ListRow({ left, right, onClick }){ return (<button className="list-row" onClick={onClick}><div className="row" style={{justifyContent:'space-between'}}><div style={{flex:1}}>{left}</div><div style={{fontWeight:700}}>{right}</div></div></button>); }

    function Modal({ open, onClose, title, children }){
      if(!open) return null;
      return (
        <div className="modal-back" onClick={onClose}>
          <div className="modal" onClick={(e)=>e.stopPropagation()}>
            <div style={{fontSize:16, fontWeight:700, marginBottom:10}}>{title}</div>
            <div style={{maxHeight:'60vh', overflow:'auto', paddingRight:4}}>{children}</div>
          </div>
        </div>
      );
    }

    function SwipeRow({ children, onDelete }){
      const ref = React.useRef(null);
      const startX = React.useRef(0), dx = React.useRef(0);
      function onTouchStart(e){ startX.current = e.touches[0].clientX; }
      function onTouchMove(e){ dx.current = Math.min(0, e.touches[0].clientX - startX.current); if(ref.current) ref.current.style.transform = \`translateX(\${dx.current}px)\`; }
      function onTouchEnd(){ const threshold = -60; if(dx.current < threshold){ if(ref.current) ref.current.style.transform = \`translateX(-84px)\`; } else { if(ref.current) ref.current.style.transform = \`translateX(0)\`; } }
      return (
        <div style={{position:'relative', overflow:'hidden'}}>
          <div style={{position:'absolute', right:0, top:0, bottom:0, width:84, background:'#ff3b30', color:'#fff', display:'grid', placeItems:'center', fontSize:13}}>
            <button className="btn danger" style={{border:'0', background:'transparent'}} onClick={onDelete}>Elimina</button>
          </div>
          <div ref={ref} ontouchstart={onTouchStart} ontouchmove={onTouchMove} ontouchend={onTouchEnd}>
            {children}
          </div>
        </div>
      );
    }

    function RecurringForm({ initial, onSave, onCancel }){
      const [name, setName] = useState(initial?.name || "");
      const [amount, setAmount] = useState(String(initial?.baseAmount ?? ""));
      const [category, setCategory] = useState(initial?.category || "Abbonamenti");
      const [frequency, setFrequency] = useState(initial?.frequency || FREQ.MONTHLY.key);
      const [day, setDay] = useState(initial?.dayOfMonth || 1);
      const [monthOfYear, setMonthOfYear] = useState(initial?.monthOfYear || 1);
      const canSave = name.trim() && !isNaN(parseFloat(amount));
      return (
        <div className="grid">
          <label className="grid"><span className="muted" style={{fontSize:12}}>Nome</span><input className="input" value={name} onChange={e=>setName(e.target.value)} placeholder="Spotify"/></label>
          <label className="grid"><span className="muted" style={{fontSize:12}}>Importo</span><input className="input" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="7.00"/></label>
          <label className="grid"><span className="muted" style={{fontSize:12}}>Categoria</span><input className="input" value={category} onChange={e=>setCategory(e.target.value)}/></label>
          <label className="grid"><span className="muted" style={{fontSize:12}}>Frequenza</span>
            <select className="input" value={frequency} onChange={e=>setFrequency(e.target.value)}>
              <option value={FREQ.MONTHLY.key}>Mensile</option>
              <option value={FREQ.YEARLY.key}>Annuale</option>
              <option value={FREQ.EVERY_X_MONTHS(2).key}>Ogni 2 mesi</option>
              <option value={FREQ.EVERY_X_MONTHS(3).key}>Ogni 3 mesi</option>
              <option value={FREQ.BIENNIAL.key}>Biennale</option>
            </select>
          </label>
          <div className="row">
            <label className="grid" style={{flex:1}}><span className="muted" style={{fontSize:12}}>Giorno</span><input className="input" type="number" value={day} onChange={e=>setDay(parseInt(e.target.value||"1",10))}/></label>
            <label className="grid" style={{flex:1}}><span className="muted" style={{fontSize:12}}>Mese (solo annuale/biennale)</span><input className="input" type="number" value={monthOfYear} onChange={e=>setMonthOfYear(parseInt(e.target.value||"1",10))}/></label>
          </div>
          <div className="row" style={{justifyContent:'flex-end'}}>
            <button className="btn ghost" onClick={onCancel}>Annulla</button>
            <button className="btn primary" disabled={!canSave} onClick={()=> onSave({ id: initial?.id || uuid(), name, baseAmount: parseFloat(amount), category, frequency, dayOfMonth: day, monthOfYear, amountOverrides: initial?.amountOverrides || {}, excludedMonths: initial?.excludedMonths || [] })}>Salva</button>
          </div>
        </div>
      );
    }

    function BudgetForm({ initial, onSave, onCancel }){
      const [category, setCategory] = useState(initial?.category || "");
      const [cap, setCap] = useState(String(initial?.cap ?? ""));
      const canSave = category.trim() && !isNaN(parseFloat(cap));
      return (
        <div className="grid">
          <label className="grid"><span className="muted" style={{fontSize:12}}>Categoria</span><input className="input" value={category} onChange={e=>setCategory(e.target.value)} placeholder="Luce"/></label>
          <label className="grid"><span className="muted" style={{fontSize:12}}>Tetto mensile</span><input className="input" value={cap} onChange={e=>setCap(e.target.value)} placeholder="70"/></label>
          <div className="row" style={{justifyContent:'flex-end'}}>
            <button className="btn ghost" onClick={onCancel}>Annulla</button>
            <button className="btn primary" disabled={!canSave} onClick={()=> onSave({ id: initial?.id || uuid(), category, cap: parseFloat(cap) })}>Salva</button>
          </div>
        </div>
      );
    }

    function MonthGrid({ refDate, items }){
      const shortWd = new Intl.DateTimeFormat('it-IT', { weekday:'short' });
      const firstOfMonth = startOfMonth(refDate);
      const start = startOfWeek(firstOfMonth);
      const days = Array.from({length: 42}, (_,i)=> addDays(start, i));
      const byDate = useMemo(()=>{
        const map = new Map();
        items.forEach(it=>{ const k = new Date(it.dateISO).toDateString(); if(!map.has(k)) map.set(k, []); map.get(k).push(it); });
        return map;
      }, [items]);
      return (
        <div>
          <div className="row muted" style={{fontSize:12, marginBottom:6, justifyContent:'space-between'}}>
            {Array.from({length:7}, (_,i)=> <div key={i} style={{width:'14%', textAlign:'left'}}>{shortWd.format(addDays(start, i))}</div>)}
          </div>
          <div className="cal-grid">
            {days.map((d,i)=>{
              const inMonth = d.getMonth()===refDate.getMonth();
              const k = d.toDateString();
              const list = byDate.get(k) || [];
              const total = list.reduce((s,x)=> s+x.amount, 0);
              return (
                <div key={i} className="cal-cell" style={{opacity: inMonth ? 1 : .45}}>
                  <div className="d">{d.getDate()}</div>
                  {list.slice(0,3).map(it=> (<div key={it.id} className="chip">• {it.title}</div>))}
                  {list.length>3 && <div className="muted" style={{fontSize:11}}>+{list.length-3} altro</div>}
                  {total>0 && <div style={{fontSize:11, fontWeight:700, position:'absolute', right:6, bottom:6}}>{cur.format(total)}</div>}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function Home({ refDate, setRefDate, planned }){
      const totalPlanned = planned.reduce((s, p)=> s+p.amount, 0);
      const totalRecurrings = planned.filter(p=>p.type==='recurring').reduce((s,p)=> s+p.amount, 0);
      const now = new Date(), in7 = new Date(now.getTime()+7*86400000);
      const soon = planned.filter(p => new Date(p.dateISO) >= now && new Date(p.dateISO) <= in7);
      const [filterOpen, setFilterOpen] = useState(false);
      const [mode, setMode] = useState('standard'); // standard | timeline

      const timeline = useMemo(()=>{
        const byMonth = planned.reduce((acc, p)=>{ const d=new Date(p.dateISO); const key=\`\${d.getFullYear()}-\${d.getMonth()+1}\`; (acc[key]=acc[key]||[]).push(p); return acc; }, {});
        const arr = Object.entries(byMonth).map(([k, items])=>({ key:k, year: +k.split('-')[0], month:+k.split('-')[1], total: items.reduce((s,x)=>s+x.amount,0), items}));
        arr.sort((a,b)=> a.year===b.year? a.month-b.month : a.year-b.year);
        return arr;
      }, [planned]);

      return (
        <div>
          <TopBar title={itMonthYear.format(refDate)} onPrev={()=>setRefDate(new Date(refDate.getFullYear(), refDate.getMonth()-1, 1))} onNext={()=>setRefDate(new Date(refDate.getFullYear(), refDate.getMonth()+1, 1))}>
            <button className="btn pill" onClick={()=>setFilterOpen(true)}>Filtro</button>
          </TopBar>

          <div className="row">
            <Stat label="Totale previsto mese" value={cur.format(totalPlanned)} />
            <Stat label="Ricorrenti del mese" value={cur.format(totalRecurrings)} />
          </div>

          {mode==='standard' && (
            <Section title="Da pagare entro 7 giorni">
              <div>
                {soon.length===0 && (<div className="muted">Niente in scadenza</div>)}
                {soon.map(item => (
                  <ListRow key={item.id}
                    left={<div><div style={{fontWeight:600}}>{item.title}</div><div className="muted" style={{fontSize:12}}>{new Date(item.dateISO).toLocaleDateString("it-IT")}</div></div>}
                    right={cur.format(item.amount)}
                  />
                ))}
              </div>
            </Section>
          )}

          {mode==='timeline' && (
            <Section title="Elenco temporale (per mese)">
              <div>
                {timeline.map(m => (
                  <div key={m.key} className="card" style={{marginBottom:8}}>
                    <div className="row" style={{justifyContent:'space-between'}}>
                      <div style={{fontWeight:700, textTransform:'capitalize'}}>{new Date(m.year, m.month-1, 1).toLocaleDateString('it-IT', { month:'long', year:'numeric'})}</div>
                      <div style={{fontWeight:800}}>{cur.format(m.total)}</div>
                    </div>
                  </div>
                ))}
              </div>
            </Section>
          )}

          <Modal open={filterOpen} onClose={()=>setFilterOpen(false)} title="Filtro">
            <div className="grid">
              <label className="row"><input type="radio" name="mode" checked={mode==='standard'} onChange={()=>setMode('standard')} /> Elenco standard</label>
              <label className="row"><input type="radio" name="mode" checked={mode==='timeline'} onChange={()=>setMode('timeline')} /> Elenco temporale (giorni/mesi/anni)</label>
            </div>
          </Modal>
        </div>
      );
    }

    function CalendarView({ refDate, setRefDate, planned }){
      return (
        <div>
          <TopBar title={itMonthYear.format(refDate)} onPrev={()=>setRefDate(new Date(refDate.getFullYear(), refDate.getMonth()-1, 1))} onNext={()=>setRefDate(new Date(refDate.getFullYear(), refDate.getMonth()+1, 1))} />
          <MonthGrid refDate={refDate} items={planned} />
        </div>
      );
    }

    function SpeseView({ recurrings, setRecurrings, budgets, setBudgets }){
      const [openRecForm, setOpenRecForm] = useState(false), [openBudForm, setOpenBudForm] = useState(false);
      const [editRec, setEditRec] = useState(null), [editBud, setEditBud] = useState(null);
      const addOrUpdateRecurring = (r) => { setRecurrings(prev=>{ const exists = prev.some(x=>x.id===r.id); const arr = exists? prev.map(x=> x.id===r.id? r:x) : [...prev, r]; saveLS(LS_KEYS.recurrings, arr); return arr; }); setOpenRecForm(false); setEditRec(null); };
      const deleteRecurring = (id) => { setRecurrings(prev=>{ const arr=prev.filter(x=>x.id!==id); saveLS(LS_KEYS.recurrings, arr); return arr; }); };
      const addOrUpdateBudget = (b) => { setBudgets(prev=>{ const exists = prev.some(x=>x.id===b.id); const arr = exists? prev.map(x=> x.id===b.id? b:x) : [...prev, b]; saveLS(LS_KEYS.budgets, arr); return arr; }); setOpenBudForm(false); setEditBud(null); };
      const deleteBudget = (id) => { setBudgets(prev=>{ const arr=prev.filter(x=>x.id!==id); saveLS(LS_KEYS.budgets, arr); return arr; }); };
      return (
        <div className="grid" style={{gap:24}}>
          <div>
            <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
              <div style={{fontSize:18, fontWeight:700}}>Ricorrenti</div>
              <button className="btn primary" onClick={()=>{ setEditRec(null); setOpenRecForm(true); }}>+ Aggiungi</button>
            </div>
            <div className="card">
              {recurrings.length===0 && <div className="muted">Nessun ricorrente</div>}
              {recurrings.map(r => (
                <SwipeRow key={r.id} onDelete={()=>deleteRecurring(r.id)}>
                  <button className="list-row" onClick={()=>{ setEditRec(r); setOpenRecForm(true); }}>
                    <div className="row" style={{justifyContent:'space-between'}}>
                      <div style={{flex:1}}>
                        <div style={{fontWeight:700}}>{r.name}</div>
                        <div className="muted" style={{fontSize:12}}>{r.frequency==='monthly'?'Mensile': r.frequency==='yearly'? 'Annuale': r.frequency==='biennial'? 'Biennale': r.frequency.replaceAll('_',' ')} · Giorno {r.dayOfMonth||1}{r.monthOfYear?` · Mese ${r.monthOfYear}`:''}</div>
                      </div>
                      <div style={{fontWeight:800}}>{cur.format(r.baseAmount)}</div>
                    </div>
                  </button>
                </SwipeRow>
              ))}
            </div>
          </div>

          <div>
            <div className="row" style={{justifyContent:'space-between', marginBottom:8}}>
              <div style={{fontSize:18, fontWeight:700}}>Previsionale</div>
              <button className="btn primary" onClick={()=>{ setEditBud(null); setOpenBudForm(true); }}>+ Budget</button>
            </div>
            <div className="card">
              {budgets.length===0 && <div className="muted">Nessuna categoria</div>}
              {budgets.map(b => (
                <SwipeRow key={b.id} onDelete={()=>deleteBudget(b.id)}>
                  <button className="list-row" onClick={()=>{ setEditBud(b); setOpenBudForm(true); }}>
                    <div className="row" style={{justifyContent:'space-between'}}>
                      <div style={{flex:1}}>{b.category}</div>
                      <div style={{fontWeight:800}}>{cur.format(b.cap)}</div>
                    </div>
                  </button>
                </SwipeRow>
              ))}
              {budgets.length>0 && (
                <div className="row" style={{justifyContent:'space-between', padding:'12px 14px', background:'#0f1216', borderRadius:12, marginTop:8}}>
                  <div style={{fontWeight:700}}>Totale previsionale mese</div>
                  <div style={{fontWeight:800}}>{cur.format(budgets.reduce((s,b)=> s+b.cap, 0))}</div>
                </div>
              )}
            </div>
          </div>

          <Modal open={openRecForm} onClose={()=>{ setOpenRecForm(false); setEditRec(null); }} title={editRec? 'Modifica ricorrente':'Nuovo ricorrente'}>
            <RecurringForm initial={editRec} onSave={addOrUpdateRecurring} onCancel={()=>{ setOpenRecForm(false); setEditRec(null); }} />
          </Modal>
          <Modal open={openBudForm} onClose={()=>{ setOpenBudForm(false); setEditBud(null); }} title={editBud? 'Modifica budget':'Nuovo budget'}>
            <BudgetForm initial={editBud} onSave={addOrUpdateBudget} onCancel={()=>{ setOpenBudForm(false); setEditBud(null); }} />
          </Modal>
        </div>
      );
    }

    function Settings({ theme, setTheme, onReset, onSeed }){
      return (
        <div className="grid" style={{gap:16}}>
          <div style={{fontSize:18, fontWeight:800}}>Impostazioni</div>
          <div className="card">
            <div className="row" style={{justifyContent:'space-between', borderBottom:'1px solid #1f2229', paddingBottom:12, marginBottom:12}}>
              <div>Tema</div>
              <select className="input" style={{width:140}} value={theme} onChange={e=>setTheme(e.target.value)}>
                <option value="light">Chiaro</option>
                <option value="dark">Scuro</option>
              </select>
            </div>
            <div className="row" style={{justifyContent:'space-between', borderBottom:'1px solid #1f2229', paddingBottom:12, marginBottom:12}}>
              <div>Ripristina dati di esempio</div>
              <button className="btn" onClick={onSeed}>Seed</button>
            </div>
            <div className="row" style={{justifyContent:'space-between'}}>
              <div>Svuota tutti i dati</div>
              <button className="btn danger" onClick={onReset}>Svuota</button>
            </div>
          </div>

          <div className="card">
            <div style={{fontWeight:700, marginBottom:8}}>Aggiungere sul telefono (iPhone)</div>
            <ol style="padding-left:18px;">
              <li>Apri questo indirizzo in Safari e fai Aggiungi a Home.</li>
              <li>Per aggiornare la versione: ricarica la pagina o chiudi/riapri l’app.</li>
            </ol>
          </div>
        </div>
      );
    }

    function App(){
      const [theme, setTheme] = useSystemTheme();
      const [tab, setTab] = useState('home');
      const [refDate, setRefDate] = useState(new Date());
      const [recurrings, setRecurrings] = useState(()=> readLS(LS_KEYS.recurrings, seedRecurrings()));
      const [budgets, setBudgets] = useState(()=> readLS(LS_KEYS.budgets, seedBudgets()));

      useEffect(()=> saveLS(LS_KEYS.recurrings, recurrings), [recurrings]);
      useEffect(()=> saveLS(LS_KEYS.budgets, budgets), [budgets]);

      const planned = useMemo(()=> generateMonthPlan(refDate, recurrings, budgets), [refDate, recurrings, budgets]);

      return (
        <div className="container">
          {tab==='home' && <Home refDate={refDate} setRefDate={setRefDate} planned={planned} />}
          {tab==='calendar' && <CalendarView refDate={refDate} setRefDate={setRefDate} planned={planned} />}
          {tab==='spese' && <SpeseView recurrings={recurrings} setRecurrings={setRecurrings} budgets={budgets} setBudgets={setBudgets} />}
          {tab==='settings' && <Settings theme={theme} setTheme={setTheme} onReset={()=>{ setRecurrings([]); setBudgets([]); }} onSeed={()=>{ setRecurrings(seedRecurrings()); setBudgets(seedBudgets()); }} />}

          <div className="tabbar">
            <div className="tabs">
              {[
                { key: 'home', label: 'Home', icon:'🏠' },
                { key: 'calendar', label: 'Calendario', icon:'📅' },
                { key: 'spese', label: 'Spese', icon:'💳' },
                { key: 'settings', label: 'Impostazioni', icon:'⚙️' },
              ].map(t => (
                <button key={t.key} className={"tab " + (tab===t.key? "active":"")} onClick={()=>setTab(t.key)}>
                  <div style={{fontSize:18}}>{t.icon}</div>
                  <div style={{fontSize:12}}>{t.label}</div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
